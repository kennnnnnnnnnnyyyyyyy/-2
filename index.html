<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>婴儿记录</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js"></script>
</head>
<body>
    <h1>婴儿喂养、睡眠、拉屎记录</h1>
    <div>
        <button id="login">登录</button>
        <button id="logout" style="display: none;">退出</button>
    </div>

    <div id="records">
        <h2>记录输入</h2>
        <form id="feed-form">
            <label for="feed-time">喂养时间:</label>
            <input type="datetime-local" id="feed-time">
            <label for="feed-type">喂养类型:</label>
            <select id="feed-type">
                <option value="breast">母乳</option>
                <option value="formula">奶粉</option>
            </select>
            <button type="submit">添加喂养记录</button>
        </form>

        <form id="sleep-form">
            <label for="sleep-start">睡眠开始:</label>
            <input type="datetime-local" id="sleep-start">
            <label for="sleep-end">睡眠结束:</label>
            <input type="datetime-local" id="sleep-end">
            <button type="submit">添加睡眠记录</button>
        </form>

        <form id="diaper-form">
            <label for="diaper-time">拉屎时间:</label>
            <input type="datetime-local" id="diaper-time">
            <label for="diaper-type">类型:</label>
            <select id="diaper-type">
                <option value="pee">尿尿</option>
                <option value="poo">拉屎</option>
            </select>
            <button type="submit">添加拉屎记录</button>
        </form>
    </div>

    <div id="statistics">
        <h2>统计图表</h2>
        <canvas id="chart" width="400" height="200"></canvas>
    </div>

    <script>
        // Firebase 初始化
        const firebaseConfig = {
            apiKey: "AIzaSyCVRKjIlYe0Q5f5sXT-CnVoH8bs3IwD2fo",
            authDomain: "baby-tracker-f8409.firebaseapp.com",
            projectId: "baby-tracker-f8409",
            storageBucket: "baby-tracker-f8409.firebasestorage.app",
            messagingSenderId: "116145937226",
            appId: "1:116145937226:web:bcf7c99fd0bed658e43fb3"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 登录和注销功能
        document.getElementById('login').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                console.log("用户登录成功", result.user);
                document.getElementById('logout').style.display = 'inline';
                document.getElementById('login').style.display = 'none';
            });
        });

        document.getElementById('logout').addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log("用户已登出");
                document.getElementById('logout').style.display = 'none';
                document.getElementById('login').style.display = 'inline';
            });
        });

        // 添加喂养记录
        document.getElementById('feed-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const feedTime = document.getElementById('feed-time').value;
            const feedType = document.getElementById('feed-type').value;
            db.collection('feedingRecords').add({
                userId: auth.currentUser.uid,
                time: feedTime,
                type: feedType
            }).then(() => {
                console.log('喂养记录添加成功');
                fetchRecords();
            });
        });

        // 添加睡眠记录
        document.getElementById('sleep-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const sleepStart = document.getElementById('sleep-start').value;
            const sleepEnd = document.getElementById('sleep-end').value;
            db.collection('sleepRecords').add({
                userId: auth.currentUser.uid,
                start: sleepStart,
                end: sleepEnd
            }).then(() => {
                console.log('睡眠记录添加成功');
                fetchRecords();
            });
        });

        // 添加拉屎记录
        document.getElementById('diaper-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const diaperTime = document.getElementById('diaper-time').value;
            const diaperType = document.getElementById('diaper-type').value;
            db.collection('diaperRecords').add({
                userId: auth.currentUser.uid,
                time: diaperTime,
                type: diaperType
            }).then(() => {
                console.log('拉屎记录添加成功');
                fetchRecords();
            });
        });

        // 获取记录并生成统计数据
        function fetchRecords() {
            let feedCount = 0;
            let sleepCount = 0;
            let diaperCount = 0;

            // 获取喂养记录
            db.collection('feedingRecords').where("userId", "==", auth.currentUser.uid).get().then(snapshot => {
                feedCount = snapshot.docs.length;
                console.log("喂养记录数量:", feedCount);
                updateChart(feedCount, sleepCount, diaperCount);
            });

            // 获取睡眠记录
            db.collection('sleepRecords').where("userId", "==", auth.currentUser.uid).get().then(snapshot => {
                sleepCount = snapshot.docs.length;
                console.log("睡眠记录数量:", sleepCount);
                updateChart(feedCount, sleepCount, diaperCount);
            });

            // 获取拉屎记录
            db.collection('diaperRecords').where("userId", "==", auth.currentUser.uid).get().then(snapshot => {
                diaperCount = snapshot.docs.length;
                console.log("拉屎记录数量:", diaperCount);
                updateChart(feedCount, sleepCount, diaperCount);
            });
        }

        // 更新图表
        function updateChart(feedCount, sleepCount, diaperCount) {
            const ctx = document.getElementById('chart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['喂养', '睡眠', '拉屎'],
                    datasets: [{
                        label: '每日记录次数',
                        data: [feedCount, sleepCount, diaperCount],  // 用从 Firebase 获取的数据更新
                        backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
