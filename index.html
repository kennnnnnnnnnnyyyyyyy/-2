<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>宝宝护理记录</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        body {
            padding: 20px;
            padding-bottom: 70px;
            background-color: #f8f9fa;
        }
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 1000;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .record-card {
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .tab-button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #f8f9fa;
            width: 100%;
        }
        .tab-button.active {
            background: #007bff;
            color: white;
        }
        .record-type-tabs {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- 记录页面 -->
    <div id="recordPage" class="page active">
        <h2 class="mb-4">添加记录</h2>
        
        <!-- 记录类型选择 -->
        <div class="record-type-tabs row mb-4">
            <div class="col-4">
                <button class="tab-button active" onclick="switchRecordType('feeding')">喂养</button>
            </div>
            <div class="col-4">
                <button class="tab-button" onclick="switchRecordType('sleep')">睡眠</button>
            </div>
            <div class="col-4">
                <button class="tab-button" onclick="switchRecordType('diaper')">排便</button>
            </div>
        </div>

        <!-- 喂养记录表单 -->
        <form id="feedingForm" class="record-form card mb-4">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">喂养量 (ml)</label>
                    <input type="number" class="form-control" name="amount" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">食物类型</label>
                    <select class="form-select" name="foodType" required>
                        <option value="母乳">母乳</option>
                        <option value="配方奶">配方奶</option>
                        <option value="辅食">辅食</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-control" name="notes">
                </div>
                <button type="submit" class="btn btn-primary w-100">添加记录</button>
            </div>
        </form>

        <!-- 睡眠记录表单 -->
        <form id="sleepForm" class="record-form card mb-4" style="display: none;">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">开始时间</label>
                    <input type="datetime-local" class="form-control" name="startTime" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">结束时间</label>
                    <input type="datetime-local" class="form-control" name="endTime">
                </div>
                <div class="mb-3">
                    <label class="form-label">睡眠质量</label>
                    <select class="form-select" name="quality" required>
                        <option value="好">好</option>
                        <option value="一般">一般</option>
                        <option value="差">差</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-control" name="notes">
                </div>
                <button type="submit" class="btn btn-primary w-100">添加记录</button>
            </div>
        </form>

        <!-- 排便记录表单 -->
        <form id="diaperForm" class="record-form card mb-4" style="display: none;">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">类型</label>
                    <select class="form-select" name="type" required>
                        <option value="尿尿">尿尿</option>
                        <option value="便便">便便</option>
                        <option value="都有">都有</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">状态</label>
                    <select class="form-select" name="status" required>
                        <option value="正常">正常</option>
                        <option value="不正常">不正常</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-control" name="notes">
                </div>
                <button type="submit" class="btn btn-primary w-100">添加记录</button>
            </div>
        </form>

        <div class="card">
            <div class="card-header">今日记录</div>
            <div class="card-body" id="recordsList">
                <div class="text-center text-muted p-4">
                    <h5>今天还没有记录哦 👶</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计页面 -->
    <div id="statsPage" class="page">
        <h2 class="mb-4">数据统计</h2>
        <div class="row mb-4">
            <div class="col-4">
                <div class="stats-card">
                    <div class="stats-number" id="todayFeeding">0</div>
                    <div class="text-muted">今日喂养(ml)</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stats-card">
                    <div class="stats-number" id="todaySleep">0</div>
                    <div class="text-muted">今日睡眠(h)</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stats-card">
                    <div class="stats-number" id="todayDiaper">0</div>
                    <div class="text-muted">今日换尿布</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#feedingChart">喂养统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sleepChart">睡眠统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#diaperChart">排便统计</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="feedingChart">
                        <canvas id="feedingWeeklyChart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="sleepChart">
                        <canvas id="sleepWeeklyChart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="diaperChart">
                        <canvas id="diaperWeeklyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="nav-bottom">
        <div class="row text-center">
            <div class="col-6">
                <button class="btn btn-primary w-100" onclick="showPage('recordPage')">记录</button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" onclick="showPage('statsPage')">统计</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase 配置和初始化
        const firebaseConfig = {
            apiKey: "AIzaSyCVRKjIlYe0Q5f5sXT-CnVoH8bs3IwD2fo",
            authDomain: "baby-tracker-f8409.firebaseapp.com",
            projectId: "baby-tracker-f8409",
            storageBucket: "baby-tracker-f8409.firebasestorage.app",
            messagingSenderId: "116145937226",
            appId: "1:116145937226:web:bcf7c99fd0bed658e43fb3"
        };
        
        // 初始化 Firebase
        const app = firebase.initializeApp({
            apiKey: "AIzaSyCVRKjIlYe0Q5f5sXT-CnVoH8bs3IwD2fo",
            authDomain: "baby-tracker-f8409.firebaseapp.com",
            projectId: "baby-tracker-f8409",
            storageBucket: "baby-tracker-f8409.firebasestorage.app",
            messagingSenderId: "116145937226",
            appId: "1:116145937226:web:bcf7c99fd0bed658e43fb3"
        });

const db = app.firestore();
const auth = app.auth();
        
        // 数据管理类
        class BabyRecords {
            constructor() {
                this.records = {
                    feeding: [],
                    sleep: [],
                    diaper: []
                };
                this.loadRecords();
            }
        
            async loadRecords() {
                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
        
                    // 加载一周内的记录
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
        
                    // 加载喂养记录
                    const feedingSnapshot = await db.collection('feeding_records')
                        .where('timestamp', '>=', weekAgo)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    this.records.feeding = feedingSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
        
                    // 加载睡眠记录
                    const sleepSnapshot = await db.collection('sleep_records')
                        .where('startTime', '>=', weekAgo)
                        .orderBy('startTime', 'desc')
                        .get();
                    
                    this.records.sleep = sleepSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
        
                    // 加载排便记录
                    const diaperSnapshot = await db.collection('diaper_records')
                        .where('timestamp', '>=', weekAgo)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    this.records.diaper = diaperSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
        
                    return this.records;
                } catch (error) {
                    console.error("加载记录失败:", error);
                    showToast('加载记录失败，请刷新重试', 'danger');
                    return [];
                }
            }
        
            async addRecord(type, data) {
                try {
                    let collection;
                    let record;
        
                    switch(type) {
                        case 'feeding':
                            collection = 'feeding_records';
                            record = {
                                amount: parseInt(data.amount),
                                foodType: data.foodType,
                                notes: data.notes || '',
                                timestamp: new Date()
                            };
                            break;
                        case 'sleep':
                            collection = 'sleep_records';
                            record = {
                                startTime: new Date(data.startTime),
                                endTime: data.endTime ? new Date(data.endTime) : null,
                                quality: data.quality,
                                notes: data.notes || '',
                                timestamp: new Date()
                            };
                            break;
                        case 'diaper':
                            collection = 'diaper_records';
                            record = {
                                type: data.type,
                                status: data.status,
                                notes: data.notes || '',
                                timestamp: new Date()
                            };
                            break;
                    }
        
                    await db.collection(collection).add(record);
                    await this.loadRecords();
                    showToast('记录添加成功！');
                    return true;
                } catch (error) {
                    console.error("添加记录失败:", error);
                    showToast('添加失败，请重试', 'danger');
                    throw error;
                }
            }
        
            getTodayRecords(type) {
                const today = new Date().toDateString();
                return this.records[type].filter(record => {
                    const recordDate = new Date(record.timestamp?.toDate() || record.startTime?.toDate()).toDateString();
                    return recordDate === today;
                });
            }
        
            getTodayStats() {
                const todayFeeding = this.getTodayRecords('feeding');
                const todaySleep = this.getTodayRecords('sleep');
                const todayDiaper = this.getTodayRecords('diaper');
        
                return {
                    feeding: {
                        total: todayFeeding.reduce((sum, record) => sum + record.amount, 0),
                        count: todayFeeding.length
                    },
                    sleep: {
                        total: todaySleep.reduce((sum, record) => {
                            if (record.endTime) {
                                const duration = (record.endTime.toDate() - record.startTime.toDate()) / (1000 * 60 * 60);
                                return sum + duration;
                            }
                            return sum;
                        }, 0),
                        count: todaySleep.length
                    },
                    diaper: {
                        count: todayDiaper.length,
                        types: todayDiaper.reduce((acc, record) => {
                            acc[record.type] = (acc[record.type] || 0) + 1;
                            return acc;
                        }, {})
                    }
                };
            }
        
            getWeeklyStats() {
                const days = [];
                const stats = {
                    feeding: [],
                    sleep: [],
                    diaper: []
                };
        
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    const nextDate = new Date(date);
                    nextDate.setDate(date.getDate() + 1);
        
                    days.push(date.toLocaleDateString('zh-CN', { weekday: 'short' }));
        
                    // 喂养统计
                    const dayFeeding = this.records.feeding.filter(record => {
                        const recordDate = record.timestamp.toDate();
                        return recordDate >= date && recordDate < nextDate;
                    });
                    stats.feeding.push(dayFeeding.reduce((sum, record) => sum + record.amount, 0));
        
                    // 睡眠统计
                    const daySleep = this.records.sleep.filter(record => {
                        const recordDate = record.startTime.toDate();
                        return recordDate >= date && recordDate < nextDate;
                    });
                    stats.sleep.push(daySleep.reduce((sum, record) => {
                        if (record.endTime) {
                            const duration = (record.endTime.toDate() - record.startTime.toDate()) / (1000 * 60 * 60);
                            return sum + duration;
                        }
                        return sum;
                    }, 0));
        
                    // 排便统计
                    const dayDiaper = this.records.diaper.filter(record => {
                        const recordDate = record.timestamp.toDate();
                        return recordDate >= date && recordDate < nextDate;
                    });
                    stats.diaper.push(dayDiaper.length);
                }
        
                return { days, stats };
            }
        }
        
        // UI 管理类
        class BabyTrackerUI {
            constructor(records) {
                this.records = records;
                this.currentType = 'feeding';
                this.setupCharts();
                this.setupEventListeners();
                this.refreshUI();
            }
        
            setupEventListeners() {
                // 设置表单提交事件
                document.querySelectorAll('.record-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formType = form.id.replace('Form', '');
                        const submitButton = form.querySelector('button[type="submit"]');
                        
                        try {
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 添加中...';
        
                            const formData = Object.fromEntries(new FormData(form));
                            await this.records.addRecord(formType, formData);
                            form.reset();
                            this.refreshUI();
                            
                        } catch (error) {
                            console.error(error);
                        } finally {
                            submitButton.disabled = false;
                            submitButton.textContent = '添加记录';
                        }
                    });
                });
            }
        
            setupCharts() {
                // 喂养图表
                const feedingCtx = document.getElementById('feedingWeeklyChart').getContext('2d');
                this.feedingChart = new Chart(feedingCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '每日总量 (ml)',
                            data: [],
                            borderColor: '#007bff',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
        
                // 睡眠图表
                const sleepCtx = document.getElementById('sleepWeeklyChart').getContext('2d');
                this.sleepChart = new Chart(sleepCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '睡眠时长 (小时)',
                            data: [],
                            borderColor: '#28a745',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
        
                // 排便图表
                const diaperCtx = document.getElementById('diaperWeeklyChart').getContext('2d');
                this.diaperChart = new Chart(diaperCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '换尿布次数',
                            data: [],
                            backgroundColor: '#ffc107'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        
            refreshUI() {
                this.updateRecordsList();
                this.updateStats();
                this.updateCharts();
            }
        
            updateRecordsList() {
                const todayRecords = this.records.getTodayRecords(this.currentType);
                const recordsList = document.getElementById('recordsList');
        
                if (todayRecords.length === 0) {
                    recordsList.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <h5>今天还没有${this.getTypeLabel(this.currentType)}记录哦 👶</h5>
                        </div>
                    `;
                    return;
                }
        
                recordsList.innerHTML = todayRecords.map(record => {
                    let content = '';
                    switch(this.currentType) {
                        case 'feeding':
                            content = `
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">
                                        ${new Date(record.timestamp.toDate()).toLocaleTimeString()}
                                    </span>
                                    <span class="fw-bold">${record.amount}ml - ${record.foodType}</span>
                                </div>
                            `;
                            break;
                        case 'sleep':
                            const duration = record.endTime ? 
                                ((record.endTime.toDate() - record.startTime.toDate()) / (1000 * 60 * 60)).toFixed(1) + '小时' :
                                '睡眠中...';
                            content = `
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">
                                        ${new Date(record.startTime.toDate()).toLocaleTimeString()}
                                    </span>
                                    <span class="fw-bold">${duration} - ${record.quality}</span>
                                </div>
                            `;
                            break;
                        case 'diaper':
                            content = `
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">
                                        ${new Date(record.timestamp.toDate()).toLocaleTimeString()}
                                    </span>
                                    <span class="fw-bold">${record.type} - ${record.status}</span>
                                </div>
                            `;
                            break;
                    }
        
                    return `
                        <div class="record-card card">
                            <div class="card-body">
                                ${content}
                                ${record.notes ? `<div class="text-muted small">${record.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        
            updateStats() {
                const stats = this.records.getTodayStats();
                document.getElementById('todayFeeding').textContent = stats.feeding.total;
                document.getElementById('todaySleep').textContent = stats.sleep.total.toFixed(1);
                document.getElementById('todayDiaper').textContent = stats.diaper.count;
            }
        
            updateCharts() {
                const { days, stats } = this.records.getWeeklyStats();
        
                // 更新喂养图表
                this.feedingChart.data.labels = days;
                this.feedingChart.data.datasets[0].data = stats.feeding;
                this.feedingChart.update();
        
                // 更新睡眠图表
                this.sleepChart.data.labels = days;
                this.sleepChart.data.datasets[0].data = stats.sleep;
                this.sleepChart.update();
        
                // 更新排便图表
                this.diaperChart.data.labels = days;
                this.diaperChart.data.datasets[0].data = stats.diaper;
                this.diaperChart.update();
            }
        
            getTypeLabel(type) {
                const labels = {
                    feeding: '喂养',
                    sleep: '睡眠',
                    diaper: '排便'
                };
                return labels[type] || '';
            }
        }
        
        // 工具函数
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            toast.style.zIndex = '1000';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function switchRecordType(type) {
            // 更新按钮状态
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`button[onclick="switchRecordType('${type}')"]`).classList.add('active');
        
            // 显示对应的表单
            document.querySelectorAll('.record-form').forEach(form => {
                form.style.display = 'none';
            });
            document.getElementById(`${type}Form`).style.display = 'block';
        
            // 更新当前类型
            window.app.currentType = type;
            window.app.updateRecordsList();
        }
        
        // 初始化应用
        window.onload = async function() {
            try {
                await firebase.auth().signInAnonymously();
                const babyRecords = new BabyRecords();
                window.app = new BabyTrackerUI(babyRecords);
            } catch (error) {
                console.error('初始化失败:', error);
                showToast('初始化失败，请刷新重试', 'danger');
            }
        };
        </script>
        </body>
        </html>